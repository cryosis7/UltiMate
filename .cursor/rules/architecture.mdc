---
description: Architectural structure of the Ulti-Mate application.
globs: source/*.mc
---
# Architecture & File Structure

The application follows the standard Connect IQ App-View-Delegate pattern, with a dedicated Model for state management.

## Components

### 1. Application (`UltiMateApp.mc`)
- Extends `Toybox.Application.AppBase`.
- Manages the application lifecycle (`onStart`, `onStop`).
- Initializes `FontConstants` module on app startup.
- Maintains reference to main view for cleanup on exit.
- `getInitialView()` returns the main `UltiMateView` and its associated `UltiMateDelegate`.

### 2. Model (`GameModel.mc`)
- Manages core game state and business logic, separated from UI concerns.
- **Responsibilities**:
    - Track scores (`dark`, `light`).
    - Track timing (game start, point start, pause state).
    - Calculate derived state (current gender ratio, next gender ratio, formatted time strings).
    - Handle game actions (`incrementDark`, `incrementLight`, `pause`, `resume`).
    - Maintain score history for undo functionality (`_historyPoints`, `_historyPointStartTimes`).

### 3. Font Constants (`FontConstants.mc`)
- Module (not a class) for caching font height values.
- **Responsibilities**:
    - Store pre-calculated font heights for all standard fonts.
    - Initialized once at app startup via `FontConstants.initialize()`.
    - Provides `FONT_TINY_HEIGHT`, `FONT_SMALL_HEIGHT`, `FONT_MEDIUM_HEIGHT`, `FONT_LARGE_HEIGHT`, and number font heights.
- **Purpose**: Avoids repeated calls to `Graphics.getFontHeight()` in `onUpdate()` methods.

### 4. View (`UltiMateView.mc`)
- Extends `Toybox.WatchUi.View`.
- **Responsibilities**:
    - Rendering the UI in `onUpdate(dc)`.
    - Managing the update timer (`_updateTimer`) which triggers screen refreshes every second.
    - Delegating game logic to `GameModel` instance.
    - Manages `ActivityRecording` session (start, stop, save, discard).
    - Provides `undoLastScore()` method for delegate to call.
    - Provides `showConfirmExit()` to push the exit confirmation view.
    - Provides `cleanup()` for proper resource cleanup on app exit.
- **Interaction**:
    - Uses `_gameModel` for all game state and logic.
    - Displays scores, times, and gender ratio from the model.

### 5. Delegate (`UltiMateDelegate.mc`)
- Extends `Toybox.WatchUi.BehaviorDelegate`.
- **Responsibilities**:
    - Handles user input during the active game (Select, Previous Page, Next Page, Back).
    - Triggers the pause state.
    - Handles Back button: undoes last score or shows confirm exit dialog.
- **Interaction**:
    - Calls `_view.incrementDark()` or `_view.incrementLight()` to update scores.
    - Calls `_view.pause()` to pause the game.
    - Calls `_view.undoLastScore()` on back press.
    - Calls `_view.showConfirmExit()` when no scores to undo.
    - Pushes `PauseMenuView` and `PauseMenuDelegate` when "Select" is pressed.

### 6. Pause Menu View (`PauseMenuView.mc`)
- Extends `Toybox.WatchUi.View`.
- **Responsibilities**:
    - Displays the "Paused" state, including a pause timer and menu options (Resume, Save, Discard).
    - Manages its own update timer to refresh the pause duration.
    - Handles visual selection state of menu items with scrolling display.
- **Interaction**:
    - Uses `_gameModel` to get formatted pause duration.
    - Calls `_view.resume()`, `_view.saveSession()`, or `_view.discardSession()` based on selection.

### 7. Pause Menu Delegate (`PauseMenuDelegate.mc`)
- Extends `Toybox.WatchUi.BehaviorDelegate`.
- **Responsibilities**:
    - Handles user input while in the pause menu.
    - Maps physical buttons (Next Page, Previous Page) to menu navigation.
    - Maps "Select" button to executing the selected menu item.
    - Maps "Back" button to resume and return to game.
- **Interaction**:
    - Calls `_view.selectNext()`, `_view.selectPrevious()`, or `_view.selectItem()` on the `PauseMenuView`.

### 8. Confirm Exit View (`ConfirmExitView.mc`)
- Extends `Toybox.WatchUi.View`.
- **Responsibilities**:
    - Displays exit confirmation dialog ("Discard and exit?").
    - Shows Yes/No options with visual selection state.
    - Warns user that game will not be saved.
- **Interaction**:
    - Calls `_view.discardSession()` and `System.exit()` if "Yes" selected.
    - Pops view if "No" selected to return to game.

### 9. Confirm Exit Delegate (`ConfirmExitDelegate.mc`)
- Extends `Toybox.WatchUi.BehaviorDelegate`.
- **Responsibilities**:
    - Handles user input in the confirm exit dialog.
    - Maps physical buttons (Next Page, Previous Page) to option selection.
    - Maps "Select" button to execute selected option.
    - Maps "Back" button to cancel and return to game.
- **Interaction**:
    - Calls `_view.selectNext()`, `_view.selectPrevious()`, or `_view.selectItem()` on the `ConfirmExitView`.

## Resource Management
- `resources/strings.xml`: Contains string definitions (e.g., AppName).
- `resources/drawables.xml`: Contains drawable definitions (e.g., launcher icon).
- `manifest.xml`: Defines app permissions, version, and supported products.
